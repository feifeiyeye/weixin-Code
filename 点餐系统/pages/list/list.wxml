<!--pages/list/list.wxml-->
<wxs module="utils">
module.exports = {
  formatPrice: function(price) {
    return '￥' + parseFloat(price).toFixed(2)
  }
}
</wxs>

<view class="page-container">
  <!-- 优惠信息 -->
  <view class="discount" wx:if="{{promotion}}">
    <text class="discount-tag">减</text>
    <text>满{{promotion.full}}元减{{promotion.reduce}}元（在线支付专享）</text>
  </view>

  <!-- 内容区域 -->
  <view class="content">
    <!-- 左侧菜单 -->
    <scroll-view class="category" scroll-y>
      <view 
        wx:for="{{foodList}}" 
        wx:key="id" 
        class="category-item {{activeIndex === index ? 'active' : ''}}"
        bindtap="tapCategory"
        data-index="{{index}}">
        <text>{{item.name}}</text>
      </view>
    </scroll-view>

    <!-- 右侧商品列表 -->
    <scroll-view 
      class="food" 
      scroll-y 
      scroll-into-view="category_{{tapIndex}}" 
      scroll-with-animation 
      bindscroll="onFoodScroll"
      enhanced
      show-scrollbar="{{false}}">
      <view 
        wx:for="{{foodList}}" 
        wx:key="id" 
        wx:for-item="category"
        id="category_{{index}}" 
        class="food-category">
        <view class="category-title">{{category.name}}</view>
        <view class="food-list">
          <view 
            class="food-item" 
            wx:for="{{category.food}}" 
            wx:key="id" 
            wx:for-item="food"
            wx:for-index="foodIndex">
            <image 
              class="food-image" 
              src="{{food.image_url}}" 
              mode="aspectFill"
              lazy-load/>
            <view class="food-info">
              <text class="food-name">{{food.name}}</text>
              <text class="food-price">{{utils.formatPrice(food.price)}}</text>
            </view>
            <view 
              class="food-add"
              catch:tap="addToCart"
              data-category_index="{{index}}"
              data-food_index="{{foodIndex}}">
              <text class="add-icon">+</text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 购物车动画小球 -->
  <view class="cartBall" hidden="{{!cartBall.show}}" style="left:{{cartBall.x}}px; top:{{cartBall.y}}px">
    <view class="ball-inner"></view>
  </view>

  <!-- 底部购物车 -->
  <view class="cart-bar">
    <view class="cart-content" bindtap="toggleCart">
      <view class="cart-icon {{cart.number > 0 ? 'active' : ''}}">
        <text class="iconfont icon-cart"></text>
        <text class="cart-badge" wx:if="{{cart.number}}">{{cart.number}}</text>
      </view>
      <view class="cart-info">
        <block wx:if="{{cart.number === 0}}">
          <text class="cart-empty">购物车是空的</text>
        </block>
        <block wx:else>
          <view class="cart-price">
            <text>{{utils.formatPrice(cart.price)}}</text>
            <text class="original-price" wx:if="{{cart.price >= promotion.full}}">
              {{utils.formatPrice(cart.price - promotion.reduce)}}
            </text>
          </view>
        </block>
      </view>
    </view>
    <view 
      class="cart-submit {{cart.number ? 'active' : ''}}"
      bindtap="submitOrder">
      选好了
    </view>
  </view>

  <!-- 购物车列表 -->
  <view class="cart-popup {{cart.show ? 'show' : ''}}">
    <view class="cart-header">
      <text class="cart-title">已选商品</text>
      <view class="cart-clear" bindtap="clearCart">
        <text>清空</text>
      </view>
    </view>
    <scroll-view class="cart-list" scroll-y>
      <view 
        class="cart-item"
        wx:for="{{cart.list}}"
        wx:key="id"
        wx:if="{{item}}">
        <text class="item-name">{{item.name}}</text>
        <text class="item-price">{{utils.formatPrice(item.price)}}</text>
        <view class="item-control">
          <text 
            class="control-btn"
            bindtap="changeNumber"
            data-type="minus"
            data-index="{{index}}">-</text>
          <text class="number">{{item.number}}</text>
          <text 
            class="control-btn"
            bindtap="changeNumber"
            data-type="add"
            data-index="{{index}}">+</text>
        </view>
      </view>
    </scroll-view>
  </view>
</view>